<template>
    <div>
        <el-row
                v-show="pages.length && !task"
                type="flex"
                justify="center"
                align="center">
            <el-col>
                <h2>К сожалению, задание не найдено.</h2>
                <p>Для выбора задания воспользуйтесь боковым навигационым меню</p>
            </el-col>
        </el-row>
        <el-row
                v-if="task">
            <el-col>
                <h2>{{ page.title }}</h2>
                <h1>{{ block.title }}</h1>
                <h1>{{ task.title }}</h1>

                <p>{{ task.text }}</p>

                <div v-if="task.questions.length"
                     v-for="(question, index) in task.questions"
                     :key="question.id">
                    <h4>Вопрос {{ index + 1}}</h4>
                    <p>{{ question.description }}</p>

                    <div v-if="question.images.length"
                         v-for="image in question.images"
                         :key="image.uid"
                         style="text-align: center">
                        <img :src="image.data" style="max-width: 100%"/>
                        <p>{{ image.name }}</p>
                    </div>

                    <div v-if="question.videos.length"
                         v-for="(video, index) in question.videos"
                         :key="index + video.url"
                         style="text-align: center">
                        <div v-player="{ url: video.url }" style="margin-bottom: 40px; margin-top: 40px"></div>
                    </div>

                    <div v-if="question.test && question.test.length">
                        <h4>Тест</h4>
                        <ol>
                           <li v-for="testItem in question.test"
                               :key="testItem.id">
                               {{ testItem.question }}
                               <div v-for="answer in testItem.answers"
                                         :key="answer.id">
                                   <el-radio v-model="testItem.checked"
                                             :class="{
                                                'answer-right': testItem.checked && answer.isCorrect && (!question.checkTestByBtn || isTestChecked),
                                                'answer-wrong': testItem.checked && !answer.isCorrect && (!question.checkTestByBtn || isTestChecked),
                                             }"
                                             :label="answer.id">{{ answer.answer }}</el-radio>
                               </div>
                           </li>
                        </ol>
                        <el-row type="flex" justify="center">
                            <p v-show="question.checkTestByBtn && isTestChecked">
                                Дано {{ countRightCheckedAnswers(question.test) }} правильных ответов из {{ question.test.length }}.
                            </p>
                        </el-row>
                        <el-row type="flex" justify="center">
                            <el-button v-show="question.checkTestByBtn && !isTestChecked"
                                       type="success"
                                       @click="checkTest()">
                                Проверить тест
                            </el-button>
                        </el-row>
                        <el-row type="flex" justify="center">
                            <el-button v-show="question.checkTestByBtn && isTestChecked"
                                       type="info"
                                       plain
                                       @click="resetTestCheck(question)">
                                Начать заного
                            </el-button>
                        </el-row>
                    </div>
                </div>

                <el-row>
                    <p v-show="task.additionalQuestion">
                        <span class="text-bold">Дополнительные вопросы:</span>
                        {{ task.additionalQuestion }}
                    </p>
                </el-row>
                <el-row>
                    <p v-show="task.comment">
                        <span class="text-bold">Комментарии:</span>
                        {{ task.comment }}
                    </p>
                </el-row>
            </el-col>
        </el-row>
    </div>
</template>

<script>
import { mapActions, mapState } from 'vuex';
import player from '../directives/player';

export default {
    directives: {
        player,
    },
    data() {
        return {
            isTestChecked: false,
            loaded: false,
            task: null,
            page: null,
            block: null,
        };
    },
    computed: {
        ...mapState([
            'pages',
        ]),
    },
    watch: {
        pages(val) {
            if (!this.loaded && val && val.length) this.getInfoFromStore();
        },
    },
    methods: {
        ...mapActions([
            'getInfo',
        ]),
        async getInfoFromStore() {
            const { pageId, blockId, taskId } = this.$route.params;
            const { task, page, block } = await this.getInfo({ pageId, blockId, taskId });
            if (!task) return;

            this.page = page;
            this.block = block;
            this.task = task;
        },
        checkTest() {
            this.isTestChecked = true;
        },
        resetTestCheck(question) {
            question.test.forEach((item) => {
                item.checked = null;
            });
            this.isTestChecked = false;
        },
        countRightCheckedAnswers(test) {
            return test.reduce((total, question) => {
                const answer = question.answers.find(item => item.id === question.checked);
                return answer && answer.isCorrect ? total + 1 : total;
            }, 0);
        },
    },
    beforeRouteUpdate(to, from, next) {
        next();

        if (to.name === 'task') {
            this.getInfoFromStore();
        }
    },
    created() {
        this.getInfoFromStore();
    },
};
</script>
<style lang="scss">
el-row {
    margin: 20px 0;
}
.text-bold {
    font-weight: bold;
}
.answer {
    &-right .el-radio__input.is-checked+.el-radio__label{
        color: #23cd23;
    }

    &-wrong .el-radio__input.is-checked+.el-radio__label{
        color: red;
    }
}
</style>
